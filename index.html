<!doctype html>
<html lang="uk" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dolki Kabana ‚Äî WebApp</title>
  <link rel="icon" href="data:,">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0b0c0f;--fg:#f2f3f5;--muted:#aeb3bc;--card:#141519;--panel:#141519;--panel2:#191b20;--stroke:rgba(255,255,255,.1);--primary:#e51e2a;--primary2:#ff4d2d;--chip:#0f1116;--ok:#2ecc71;--warn:#f59e0b}
    html[data-theme="light"]{--bg:#f7f7f9;--fg:#111112;--muted:#596077;--card:#ffffff;--panel:#ffffff;--panel2:#f3f4f6;--stroke:rgba(0,0,0,.12);--primary:#e51e2a;--primary2:#ff4d2d;--chip:#f2f3f7;--ok:#1f7a35;--warn:#b57100}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;background:color-mix(in oklab,var(--bg) 85%,transparent);backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid var(--stroke);z-index:10}
    .head{max-width:960px;margin:0 auto;padding:12px;display:flex;align-items:center;gap:12px}
    .brand{font-weight:900;cursor:pointer}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .freebar{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px dashed var(--stroke);border-radius:12px;margin:8px 0;font-size:14px}
    .progress{flex:1;height:10px;background:color-mix(in oklab,var(--bg) 70%,transparent);border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--primary),var(--primary2))}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .media{position:relative;height:160px;background:#0e0f13}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .sticker{position:absolute;top:10px;left:10px;display:flex;gap:8px}
    .badge{background:var(--primary);color:#fff;border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
    .badge.secondary{background:var(--primary2)}
    .body{padding:12px;display:flex;flex-direction:column;gap:10px}
    .title{margin:0;font-size:18px;font-weight:900}
    .sub{color:var(--muted);font-size:13px}
    .rating{color:#ffd166;font-weight:800}
    /* —Ç—Ä–∏ —Ä–∞–≤–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ */
    .variants{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .variants .opt{height:100%}
    .opt{position:relative;border:1px solid var(--stroke);border-radius:14px;background:linear-gradient(180deg,var(--panel),var(--panel2));padding:26px 12px 12px;cursor:pointer;min-height:96px;transition:all .2s ease}
    .opt.is-selected{outline:2px solid color-mix(in oklab,var(--primary) 60%,var(--primary2));transform:translateY(-2px);}
    .ribbon{position:absolute;top:6px;left:50%;transform:translateX(-50%);background:var(--chip);color:var(--fg);border:1px solid var(--stroke);font-size:10px;font-weight:800;border-radius:999px;padding:2px 8px;max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:.9;pointer-events:none}
    .w{font-size:13px;color:var(--muted);font-weight:700;text-align:center}
    .p{font-size:20px;font-weight:900;text-align:center;color:var(--fg);text-shadow:0 1px 0 rgba(0,0,0,.45)}
    html[data-theme="light"] .p{color:#111}
    .per{display:none!important}
    .savings{display:flex;justify-content:space-between;align-items:center;font-size:13px}
    .sv{font-weight:800;color:var(--ok)}
    .stock{color:var(--warn);font-weight:700}
    .cta{display:flex;flex-direction:column;gap:8px}
    .btn{display:flex;align-items:center;justify-content:center;gap:10px;border:none;border-radius:14px;padding:14px;font-weight:900;cursor:pointer;background:linear-gradient(180deg,var(--primary) 86%,var(--primary2));color:#fff;box-shadow:0 8px 20px rgba(229,30,42,.25);transition:all .2s ease}
    .btn:hover{opacity:.9;transform:translateY(-2px)}
    .smallbtn{display:flex;align-items:center;gap:6px;border:1px solid var(--stroke);background:var(--panel2);color:var(--fg);border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;transition:all .2s ease}
    .smallbtn:hover{background:var(--primary);color:#fff}
    .meta{display:flex;justify-content:space-between;color:var(--muted);font-size:12px}
    .meta [id^="per-"]{display:none!important}
    .wctrl{display:flex;align-items:center;gap:8px;margin-top:6px;width:100%}
    .wctrl .nbtn{border:1px solid var(--stroke);background:var(--panel2);color:var(--fg);border-radius:10px;padding:12px 10px;font-weight:900;cursor:pointer;flex:1;transition:all .2s ease}
    .wctrl .nbtn:hover{background:var(--primary);color:#fff}
    .wctrl input{width:100%;max-width:none;text-align:center;border:1px solid var(--stroke);background:var(--panel2);color:var(--fg);border-radius:10px;padding:12px 10px;flex:2}
    .wctrl small{color:var(--muted)}

    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:11}
    .backdrop.show{opacity:1;pointer-events:auto}
    .sheet{position:fixed;left:0;right:0;bottom:-100%;background:var(--panel);border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -20px 40px rgba(0,0,0,.4);transition:bottom .25s ease;border:1px solid var(--stroke);z-index:12}
    .sheet.open{bottom:0}
    .sheet .grab{width:48px;height:5px;border-radius:999px;background:var(--stroke);margin:8px auto}
    .sheet .toolbar{display:flex;align-items:center;gap:8px;padding:0 12px 6px}
    .sheet .close{margin-left:auto;border:1px solid var(--stroke);background:var(--panel2);color:var(--fg);border-radius:10px;padding:6px 10px;cursor:pointer;transition:all .2s ease}
    .sheet .close:hover{background:var(--primary);color:#fff}
    .cart{max-height:42vh;overflow:auto;padding:8px 12px 8px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px 0;border-bottom:1px dashed var(--stroke)}
    .row h4{margin:0;font-size:14px}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{border:1px solid var(--stroke);background:var(--panel2);color:var(--fg);border-radius:10px;padding:6px 10px;cursor:pointer;transition:all .2s ease}
    .qty button:hover{background:var(--primary);color:#fff}

    /* Cart card styles matching reference design */
    .cart-card{display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:12px;margin-bottom:10px;}
    .cart-card img{width:64px;height:64px;object-fit:cover;border-radius:12px;}
    .cart-card .cc-info{flex:1;display:flex;flex-direction:column;gap:4px;}
    .cart-card .cc-info .cc-title{font-size:15px;font-weight:900;margin:0;}
    .cart-card .cc-info .cc-sub{font-size:12px;color:var(--muted);}
    .cart-card .cc-price{font-size:18px;font-weight:900;text-align:right;margin-right:8px;}
    .cart-card .cc-controls{display:flex;align-items:center;gap:6px;}
    .cart-card .cc-controls .qty-btn{border:none;background:var(--panel2);color:var(--fg);border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px;cursor:pointer;transition:all .2s ease;}
    .cart-card .cc-controls .qty-btn.plus{background:linear-gradient(180deg,var(--primary) 86%,var(--primary2));color:#fff;box-shadow:0 4px 8px rgba(229,30,42,.25);}
    .cart-card .cc-controls .qty-num{min-width:20px;text-align:center;font-weight:700;}

    .form{padding:10px 12px 12px;display:none}
    .form.show{display:block}
    .fgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .fgrid-1{display:grid;grid-template-columns:1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-size:12px;color:var(--muted)}
    .input,.select,.radio-group button{border:1px solid var(--stroke);background:var(--panel2);color:var(--fg);border-radius:12px;padding:12px}
    .radio-group{display:flex;gap:8px}
    .radio-group button{cursor:pointer;transition:all .2s ease}
    .radio-group button.active,.radio-group button:hover{outline:2px solid var(--primary);background:var(--primary);color:#fff}
    .summary{position:sticky;bottom:0;background:var(--panel2);border-top:1px solid var(--stroke);padding:10px 12px;display:flex;flex-direction:column;gap:6px}
    .summary .line{display:flex;justify-content:space-between;font-size:14px}
    .summary .free{font-weight:900;display:flex;align-items:center;gap:8px}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:var(--panel2);color:var(--fg);border:1px solid var(--stroke);border-radius:12px;padding:10px 14px;box-shadow:0 10px 26px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:20}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <div class="head">
      <div id="brand" class="brand">üê∑ Dolki Kabana</div>
      <div style="flex:1"></div>
      <button id="theme" class="smallbtn">üåì <span>–¢–µ–º–∞</span></button>
      <button id="openCart" class="smallbtn">üõí <span id="cartCount">0</span></button>
    </div>
  </header>

  <main class="wrap">
    <div class="freebar" id="freebar">
      <span id="freeText">–î–æ–¥–∞–π—Ç–µ —â–µ –Ω–∞ 40,00¬†‚Ç¨ ‚Äî —ñ –¥–æ—Å—Ç–∞–≤–∫–∞ –±—É–¥–µ –ë–ï–ó–ö–û–®–¢–û–í–ù–ê üöö</span>
      <div class="progress"><i id="prg"></i></div>
    </div>
    <div id="grid" class="grid"></div>
  </main>

  <div class="backdrop" id="backdrop"></div>
  <div class="sheet" id="sheet" aria-label="–ö–æ—à–∏–∫">
    <div class="grab"></div>
    <div class="toolbar"><b id="sheetTitle">–ö–æ—à–∏–∫</b><button class="close" id="closeCart">‚úñ –ó–∞–∫—Ä–∏—Ç–∏</button></div>
    <div class="cart" id="cart"></div>

    <form class="form" id="form" novalidate>
      <div class="fgrid">
        <div class="field"><label class="label">–ü—Ä—ñ–∑–≤–∏—â–µ</label><input class="input" id="lastName" required></div>
        <div class="field"><label class="label">–Ü–º'—è</label><input class="input" id="firstName" required></div>
      </div>
      <div class="fgrid">
        <div class="field"><label class="label">–¢–µ–ª–µ—Ñ–æ–Ω</label><input class="input" id="phone" inputmode="tel" placeholder="+49 ..." required></div>
        <div class="field"><label class="label">Email (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label><input class="input" id="email" inputmode="email" placeholder="you@mail.com"></div>
      </div>
      <div class="field">
        <label class="label">–î–æ—Å—Ç–∞–≤–∫–∞</label>
        <div class="radio-group" id="deliveryGroup">
          <button type="button" data-val="delivery" class="active">üöö –ö—É—Ä'—î—Ä</button>
          <button type="button" data-val="pickup">üè¨ –°–∞–º–æ–≤–∏–≤—ñ–∑</button>
        </div>
      </div>
      <div id="deliveryFields" class="fgrid">
        <div class="field"><label class="label">–ú—ñ—Å—Ç–æ</label><input class="input" id="city" placeholder="–ë—Ä–µ–º–µ–Ω" required></div>
        <div class="field"><label class="label">–í—É–ª–∏—Ü—è</label><input class="input" id="street" placeholder="..." required></div>
        <div class="field"><label class="label">–ë—É–¥–∏–Ω–æ–∫</label><input class="input" id="house" required></div>
        <div class="field"><label class="label">–ö–≤–∞—Ä—Ç–∏—Ä–∞ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label><input class="input" id="apt"></div>
      </div>
      <div id="pickupFields" class="fgrid-1" style="display:none">
        <div class="field"><label class="label">–ü—É–Ω–∫—Ç —Å–∞–º–æ–≤–∏–≤–æ–∑—É</label>
          <select class="select" id="pickupPoint">
            <option value="store-1" selected>–ë—Ä–µ–º–µ–Ω, Markt 1 (10:00‚Äì19:00)</option>
            <option value="store-2">–ë—Ä–µ–º–µ–Ω, √úberseestadt (11:00‚Äì20:00)</option>
          </select>
        </div>
      </div>
    </form>

    <div class="summary" id="summary">
      <div class="line"><span>–°—É–º–∞</span><b id="sum">0,00¬†‚Ç¨</b></div>
      <div class="line"><span>–ï–∫–æ–Ω–æ–º—ñ—è</span><b id="save">0,00¬†‚Ç¨</b></div>
      <div class="line free" id="freeHint">–î–æ–¥–∞–π—Ç–µ —â–µ –Ω–∞ 40,00¬†‚Ç¨ ‚Äî –±—É–¥–µ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ üöö <button class="smallbtn" id="ctaPickup">üè¨ –í–∏–±—Ä–∞—Ç–∏ —É –º–∞–≥–∞–∑–∏–Ω—ñ</button></div>
      <button class="btn checkout" id="checkout">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
    </div>
  </div>

  <div class="toast" id="toast">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –≤ –±–æ—Ç ‚úÖ</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
(function(){
  // --- Telegram helper (–±–µ–∑ optional chaining) ---
  function tg(){ return (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null; }
  var $html=document.documentElement;
  function applyTheme(){ try{ var T=tg(); var scheme=(T&&T.colorScheme)||'dark'; $html.setAttribute('data-theme', scheme==='light'?'light':'dark'); if(T&&T.setHeaderColor) T.setHeaderColor('bg_color'); if(T&&T.setBottomBarColor) T.setBottomBarColor(scheme==='light'?'#ffffff':'#0b0c0f'); }catch(e){} }
  applyTheme(); if(tg()&&tg().onEvent) tg().onEvent('themeChanged', applyTheme);

  // --- Helpers ---
  var FREE=40;
  function money(v){ return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(v); }
  function num(n,d){ d=d==null?2:d; return n.toLocaleString('de-DE',{minimumFractionDigits:d,maximumFractionDigits:d}); }
  function baseline(p, g){ return p.base100*(g/100); }
  function savings(p,t){ var base=baseline(p,t.g); var sv=Math.max(0, base - t.p); var pct=base? sv/base*100:0; return {sv:sv,pct:pct}; }
  function discLabel(x){ return x.pct>=5? ('-'+Math.round(x.pct)+'%') : null }
  function niceTag(tag){ if(!tag) return null; var map={'–Ω–∞–π–≤–∏–≥—ñ–¥–Ω—ñ—à–∏–π':'–≤–∏–≥—ñ–¥–Ω–æ','–ø–æ–ø—É–ª—è—Ä–Ω–∏–π':'—Ö—ñ—Ç'}; return map[tag]||tag; }

  // --- Data ---
  var PRODUCTS=[
    {id:'basturma',name:'–ë–∞—Å—Ç—É—Ä–º–∞ –ø—Ä–µ–º—ñ—É–º',sub:'–ù–∞—Ç—É—Ä–∞–ª—å–Ω–æ ‚Ä¢ –ë–µ–∑ —Ö—ñ–º—ñ—ó',img:'https://www.svoim.in.ua/wp-content/uploads/2018/12/Basturma-ialovycha-Svoi-m4.jpg',base100:4.99,rating:5,reviews:238,stock:7,tiers:[{g:100,p:4.99},{g:250,p:11.99,tag:'–ø–æ–ø—É–ª—è—Ä–Ω–∏–π'},{g:500,p:19.99,tag:'–Ω–∞–π–≤–∏–≥—ñ–¥–Ω—ñ—à–∏–π'}]},
    {id:'ribs',name:'–†–µ–±—Ä–∞ —Å–≤–∏–Ω—è—á—ñ –∫–æ–ø—á–µ–Ω—ñ',sub:'–°–æ–∫–æ–≤–∏—Ç—ñ ‚Ä¢ –î–æ –ø–∏–≤–∞',img:'https://beefbrisket.ru/wp-content/uploads/2020/08/beefbrisket_Moscow_01.2021_8.jpg',base100:3.99,rating:4.9,reviews:181,stock:10,tiers:[{g:250,p:8.99},{g:500,p:15.99,tag:'–ø–æ–ø—É–ª—è—Ä–Ω–∏–π'},{g:1000,p:28.99,tag:'–Ω–∞–π–≤–∏–≥—ñ–¥–Ω—ñ—à–∏–π'}]},
    {id:'bacon',name:'–ì—Ä—É–¥–∏–Ω–∫–∞ –∫–æ–ø—á–µ–Ω–∞',sub:'–î–æ–º–∞—à–Ω—è ‚Ä¢ –ó–∞–ø–∞—à–Ω–∞',img:'https://www.hobbi-smoke.ru/wp-content/uploads/2022/09/grudinka-reczepty.jpg',base100:2.99,rating:4.95,reviews:324,stock:12,tiers:[{g:250,p:7.99},{g:500,p:12.99,tag:'–ø–æ–ø—É–ª—è—Ä–Ω–∏–π'},{g:1000,p:22.99,tag:'–Ω–∞–π–≤–∏–≥—ñ–¥–Ω—ñ—à–∏–π'}]},
    {id:'ears',name:'–ö–æ–ø—á–µ–Ω—ñ —É—à–∫–∏',sub:'–ì–æ—Å—Ç—Ä–µ–Ω—å–∫—ñ ‚Ä¢ –î–æ –ø–∏–≤–∞',img:'https://images.unsplash.com/photo-1604908177076-8f98cabd5c7e?auto=format&fit=crop&w=1200&q=80',base100:3.49,rating:4.6,reviews:75,stock:15,tiers:[{g:100,p:3.49},{g:250,p:8.49},{g:500,p:14.99,tag:'–Ω–∞–π–≤–∏–≥—ñ–¥–Ω—ñ—à–∏–π'}]},
    {id:'quail',name:'–ü–µ—Ä–µ–ø–µ–ª–∫–∞',sub:'–ù—ñ–∂–Ω–µ –º‚Äô—è—Å–æ ‚Ä¢ –î–µ–ª—ñ–∫–∞—Ç–µ—Å',img:'https://images.unsplash.com/photo-1604908177076-8f98cabd5c7e?auto=format&fit=crop&w=1200&q=80',base100:5.99,rating:4.8,reviews:150,stock:10,tiers:[{g:200,p:11.99},{g:400,p:22.99},{g:600,p:32.99,tag:'–ø–æ–ø—É–ª—è—Ä–Ω–∏–π'}]},
    {id:'balyk',name:'–ë–∞–ª—ã–∫',sub:'–°—É—à–µ–Ω–µ ‚Ä¢ –ê—Ä–æ–º–∞—Ç–Ω–µ',img:'https://images.unsplash.com/photo-1604908177076-8f98cabd5c7e?auto=format&fit=crop&w=1200&q=80',base100:4.59,rating:4.7,reviews:190,stock:8,tiers:[{g:100,p:4.59},{g:250,p:10.99,tag:'–ø–æ–ø—É–ª—è—Ä–Ω–∏–π'},{g:500,p:19.99,tag:'–Ω–∞–π–≤–∏–≥—ñ–¥–Ω—ñ—à–∏–π'}]},
    {id:'wings',name:'–ö—É—Ä—è—á—ñ –∫—Ä–∏–ª—å—Ü—è',sub:'–ú–∞—Ä–∏–Ω–æ–≤–∞–Ω—ñ ‚Ä¢ –°–æ–∫–æ–≤–∏—Ç—ñ',img:'https://images.unsplash.com/photo-1604908177076-8f98cabd5c7e?auto=format&fit=crop&w=1200&q=80',base100:2.49,rating:4.5,reviews:230,stock:20,tiers:[{g:250,p:6.49},{g:500,p:11.49,tag:'–ø–æ–ø—É–ª—è—Ä–Ω–∏–π'},{g:1000,p:20.99,tag:'–Ω–∞–π–≤–∏–≥—ñ–¥–Ω—ñ—à–∏–π'}]},
    {id:'legs',name:'–ö—É—Ä—è—á—ñ –æ–∫–æ—Ä–æ—á–∫–∞',sub:'–¢—Ä–∞–¥–∏—Ü—ñ–π–Ω—ñ ‚Ä¢ –ù—ñ–∂–Ω—ñ',img:'https://images.unsplash.com/photo-1604908177076-8f98cabd5c7e?auto=format&fit=crop&w=1200&q=80',base100:1.99,rating:4.3,reviews:200,stock:25,tiers:[{g:500,p:6.99},{g:1000,p:12.99,tag:'–ø–æ–ø—É–ª—è—Ä–Ω–∏–π'},{g:2000,p:24.99,tag:'–Ω–∞–π–≤–∏–≥—ñ–¥–Ω—ñ—à–∏–π'}]}
  ];

  // --- Refs ---
  var $grid=document.getElementById('grid');
  var $sheet=document.getElementById('sheet');
  var $backdrop=document.getElementById('backdrop');
  var $cart=document.getElementById('cart');
  var $sum=document.getElementById('sum');
  var $save=document.getElementById('save');
  var $freeHint=document.getElementById('freeHint');
  var $count=document.getElementById('cartCount');
  var $freeText=document.getElementById('freeText');
  var $prg=document.getElementById('prg');
  var $toast=document.getElementById('toast');
  var $form=document.getElementById('form');
  var $deliveryGroup=document.getElementById('deliveryGroup');
  var $deliveryFields=document.getElementById('deliveryFields');
  var $pickupFields=document.getElementById('pickupFields');

  function toast(msg){ $toast.textContent=msg; $toast.classList.add('show'); setTimeout(function(){ $toast.classList.remove('show'); }, 1500); }

  var cart=[];
  function getCartSum(){ var s=0; for(var i=0;i<cart.length;i++){ s+=cart[i].price*cart[i].qty; } return s; }

  // --- Render products ---
  function render(){
    $grid.innerHTML='';
    PRODUCTS.forEach(function(p){
      var card=document.createElement('article'); card.className='card';
      var isHit=(p.reviews||0)>200; var isLimit=(p.stock||0)<=7;
      var badges=(isHit? '<span class="badge">–•–Ü–¢<\/span>':'') + (isLimit? '<span class="badge secondary">–õ—ñ–º—ñ—Ç<\/span>':'');
      card.innerHTML='\
      <div class="media"><img src="'+p.img+'" alt="'+p.name+'" data-fallback="https:\/\/images.unsplash.com\/photo-1604908177076-8f98cabd5c7e?auto=format&amp;fit=crop&amp;w=1200&amp;q=80" onerror="this.onerror=null;this.src=this.dataset.fallback"><div class="sticker">'+badges+'<\/div><\/div>\
      <div class="body">\
        <h3 class="title">'+p.name+'<\/h3>\
        <div class="rating">‚≠ê '+p.rating.toFixed(2)+' <small style="color:var(--muted)">('+p.reviews+')<\/small><\/div>\
        <div class="sub">'+p.sub+'<\/div>\
        <div class="variants" id="v-'+p.id+'"><\/div>\
        <div class="wctrl">\
          <button class="nbtn" id="dec-'+p.id+'">‚àí<\/button>\
          <input id="grams-'+p.id+'" inputmode="numeric" pattern="[0-9]*" step="100" min="100"> <small>–≥<\/small>\
          <button class="nbtn" id="inc-'+p.id+'">+<\/button>\
        <\/div>\
        <div class="savings">'+(isLimit? '<span class="stock">–ó–∞–ª–∏—à–∏–ª–æ—Å—å '+p.stock+'<\/span>':'')+'<span>–í–∏–≥–æ–¥–∞: <b class="sv" id="sv-'+p.id+'">‚Äî<\/b><\/span><\/div>\
        <div class="cta"><button class="btn" id="add-'+p.id+'">üõí –î–æ–¥–∞—Ç–∏ —É –∫–æ—à–∏–∫<\/button><div class="meta"><span id="free-'+p.id+'"><\/span><span id="per-'+p.id+'">‚Äî \/ 100 –≥<\/span><\/div><\/div>\
      <\/div>';
      $grid.appendChild(card);

      var $v=card.querySelector('#v-'+p.id);
      var selected=Math.min(1,p.tiers.length-1); var grams=p.tiers[selected].g;
      var $ginput=card.querySelector('#grams-'+p.id); $ginput.value=grams;
      var $inc=card.querySelector('#inc-'+p.id); var $dec=card.querySelector('#dec-'+p.id);

      var tmap={}; p.tiers.forEach(function(t){ tmap[t.g]=t.p; });
      function priceFor(w){ return (tmap[w]!=null)? tmap[w] : baseline(p,w); }

      function renderVariants(){
        $v.innerHTML='';
        p.tiers.forEach(function(t,idx){
          var s=savings(p,t); var disc=discLabel({pct:s.pct}); var label=niceTag(t.tag)||disc;
          var el=document.createElement('button'); el.className='opt'+(idx===selected?' is-selected':''); el.type='button';
          el.innerHTML=(label? '<span class="ribbon">'+label+'<\/span>':'')+'\
            <div class="w">'+t.g+' –≥<\/div>\
            <div class="p">'+money(t.p)+'<\/div>';
          el.addEventListener('click', function(){ selected=idx; grams=t.g; $ginput.value=grams; update(); });
          $v.appendChild(el);
        });
      }

      var $sv=card.querySelector('#sv-'+p.id);
      var $per=card.querySelector('#per-'+p.id);
      var $free=card.querySelector('#free-'+p.id);
      var $add=card.querySelector('#add-'+p.id);

      function update(){
        var kids=[].slice.call($v.children); for(var i=0;i<kids.length;i++){ kids[i].classList.toggle('is-selected', i===selected); }
        var price=priceFor(grams); var per100=price/(grams/100); var base=baseline(p,grams);
        var sv=Math.max(0, base-price); var pct=base? sv/base*100:0;
        $sv.textContent = sv>0? (money(sv)+' (‚àí'+Math.round(pct)+'%)') : '–±–µ–∑ –∑–Ω–∏–∂–∫–∏';
        $per.textContent = num(per100)+' / 100 –≥';
        $free.textContent='';
        var leftNow=Math.max(0, FREE-getCartSum());
        $per.style.visibility = leftNow>0 ? 'hidden' : 'visible';
        $add.textContent='üõí –î–æ–¥–∞—Ç–∏ '+grams+' –≥ ‚Äî '+money(price);
        $add.onclick=function(){ addToCart(p,{g:grams,p:price}); };
      }

      renderVariants();
      $inc.onclick=function(){ grams=Math.min(5000,grams+100); $ginput.value=grams; var idx=p.tiers.findIndex(function(tt){return tt.g===grams}); selected=idx>-1?idx:selected; update(); };
      $dec.onclick=function(){ grams=Math.max(100,grams-100); $ginput.value=grams; var idx=p.tiers.findIndex(function(tt){return tt.g===grams}); selected=idx>-1?idx:selected; update(); };
      $ginput.addEventListener('change', function(){ var v=parseInt($ginput.value,10)||grams; v=Math.max(100,Math.min(5000,v)); v=Math.round(v/100)*100; grams=v; var idx=p.tiers.findIndex(function(tt){return tt.g===grams}); selected=idx>-1?idx:selected; $ginput.value=v; update(); });
      update();

      card.updateMeta=update;
    });
  }

  function openCart(){ $sheet.classList.add('open'); $backdrop.classList.add('show'); }
  function closeCart(){ $sheet.classList.remove('open'); $backdrop.classList.remove('show'); }

  function addToCart(p,t){
    var key=p.id+'-'+t.g;
    var ex=null;
    for(var i=0;i<cart.length;i++){
      if(cart[i].key===key){ ex=cart[i]; break; }
    }
    if(ex) {
      ex.qty++;
    } else {
      // store image to display in cart
      cart.push({
        key:key,
        id:p.id,
        img:p.img,
        name:p.name,
        grams:t.g,
        price:t.p,
        base:baseline(p,t.g),
        qty:1
      });
    }
    openCart();
    syncCart();
  }

  function syncCart(){
    $cart.innerHTML=''; var sum=0, save=0, qty=0;
    for(var i=0;i<cart.length;i++){
      var it=cart[i];
      var per100=it.price/(it.grams/100);
      var sv=Math.max(0, it.base-it.price)*it.qty;
      save+=sv;
      sum+=it.price*it.qty;
      qty+=it.qty;
      // create a cart item card
      var card=document.createElement('div');
      card.className='cart-card';
      // image element
      var img=document.createElement('img');
      img.src = it.img || '';
      img.alt = it.name;
      img.onerror = function(){ this.style.display='none'; };
      card.appendChild(img);
      // info container
      var info=document.createElement('div');
      info.className='cc-info';
      var title=document.createElement('div'); title.className='cc-title'; title.textContent=it.name;
      var sub=document.createElement('div'); sub.className='cc-sub'; sub.textContent=it.grams+' –≥';
      info.appendChild(title);
      info.appendChild(sub);
      card.appendChild(info);
      // price and controls wrapper
      var wrapper=document.createElement('div');
      wrapper.style.display='flex';
      wrapper.style.flexDirection='column';
      wrapper.style.alignItems='flex-end';
      // price
      var priceEl=document.createElement('div'); priceEl.className='cc-price'; priceEl.textContent=money(it.price*it.qty);
      wrapper.appendChild(priceEl);
      // controls
      var controls=document.createElement('div'); controls.className='cc-controls';
      // minus button
      var minus=document.createElement('button'); minus.className='qty-btn'; minus.setAttribute('data-k', it.key); minus.setAttribute('data-a', '-'); minus.textContent='‚àí';
      controls.appendChild(minus);
      // qty number
      var qtyNum=document.createElement('span'); qtyNum.className='qty-num'; qtyNum.textContent=it.qty;
      controls.appendChild(qtyNum);
      // plus button
      var plus=document.createElement('button'); plus.className='qty-btn plus'; plus.setAttribute('data-k', it.key); plus.setAttribute('data-a', '+'); plus.textContent='+';
      controls.appendChild(plus);
      wrapper.appendChild(controls);
      card.appendChild(wrapper);
      $cart.appendChild(card);
    }
    $sum.textContent=money(sum); $save.textContent=money(save);
    var left=Math.max(0, FREE-sum);
    $freeHint.innerHTML = left>0
      ? ('–î–æ–¥–∞–π—Ç–µ —â–µ –Ω–∞ '+money(left)+' ‚Äî –±—É–¥–µ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ üöö <button class="smallbtn" id="ctaPickup">üè¨ –í–∏–±—Ä–∞—Ç–∏ —É –º–∞–≥–∞–∑–∏–Ω—ñ<\/button>')
      : '–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞ üöö';
    $count.textContent=qty;

    var pct=Math.min(100,(sum/FREE)*100); $prg.style.width=(pct>100?100:pct)+'%'; $freeText.textContent = left>0 ? ('–î–æ–¥–∞–π—Ç–µ —â–µ –Ω–∞ '+money(left)+' ‚Äî —ñ –¥–æ—Å—Ç–∞–≤–∫–∞ –±—É–¥–µ –ë–ï–ó–ö–û–®–¢–û–í–ù–ê üöö') : '–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞ üöö';

    var btns=$cart.querySelectorAll('button'); for(var j=0;j<btns.length;j++){ btns[j].onclick=function(){ var k=this.getAttribute('data-k'); var a=this.getAttribute('data-a'); var item=null,idx=-1; for(var q=0;q<cart.length;q++){ if(cart[q].key===k){ item=cart[q]; idx=q; break; } } if(!item) return; if(a==='+') item.qty++; else item.qty=Math.max(0,item.qty-1); if(item.qty===0 && idx>-1) cart.splice(idx,1); syncCart(); }; }

    var cta=document.getElementById('ctaPickup'); if(cta){ cta.onclick=function(){ closeCart(); window.scrollTo({top:0,behavior:'smooth'}); toast('–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä ‚Äî —Å–∞–º–æ–≤–∏–≤—ñ–∑ –º–æ–∂–Ω–∞ –≤–∏–±—Ä–∞—Ç–∏ –ø—ñ–¥ —á–∞—Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è'); }; }

    var cards=document.querySelectorAll('.card'); for(var c=0;c<cards.length;c++){ if(cards[c].updateMeta) cards[c].updateMeta(); }
  }

  // --- Delivery toggle buttons ---
  (function(){ var btns=$deliveryGroup.querySelectorAll('button'); for(var i=0;i<btns.length;i++){ btns[i].onclick=function(){ for(var k=0;k<btns.length;k++) btns[k].classList.remove('active'); this.classList.add('active'); var mode=this.getAttribute('data-val'); var isPickup=mode==='pickup'; $deliveryFields.style.display=isPickup?'none':'grid'; $pickupFields.style.display=isPickup?'grid':'none'; }; } })();

  // --- Open/close & actions ---
  document.getElementById('openCart').onclick=openCart; document.getElementById('closeCart').onclick=closeCart; document.getElementById('backdrop').onclick=closeCart; document.getElementById('brand').onclick=function(){ closeCart(); window.scrollTo({top:0,behavior:'smooth'}); };
  document.getElementById('theme').onclick=function(){ var t=$html.getAttribute('data-theme')==='dark'?'light':'dark'; $html.setAttribute('data-theme',t); };

  // --- Checkout ---
  document.getElementById('checkout').onclick=function(){
    if(!cart.length){ toast('–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    var isForm=document.getElementById('form').classList.contains('show');
    if(!isForm){ setMode('form'); return; }
    submitOrder();
  };

  function setMode(mode){
    var isForm=mode==='form';
    document.getElementById('cart').style.display=isForm?'none':'block';
    document.getElementById('form').classList.toggle('show', isForm);
    document.getElementById('sheetTitle').textContent=isForm?'–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è':'–ö–æ—à–∏–∫';
    if(isForm){
      var ids=['lastName','firstName','phone','city','street','house'];
      for(var i=0;i<ids.length;i++){
        var el=document.getElementById(ids[i]);
        if(el && el.offsetParent!==null && !el.value.trim()){ el.focus(); break; }
      }
    }
  }

  function buildPayload(){ var modeBtn=$deliveryGroup.querySelector('.active'); var mode=(modeBtn&&modeBtn.getAttribute('data-val'))||'delivery'; return { items: cart.map(function(i){return {id:i.id,grams:i.grams,price:i.price,qty:i.qty};}), sum:$sum.textContent, customer:{ firstName:document.getElementById('firstName').value.trim(), lastName:document.getElementById('lastName').value.trim(), phone:document.getElementById('phone').value.trim(), email:(document.getElementById('email').value.trim()||null) }, fulfillment: (mode==='pickup')? {type:'pickup',point:document.getElementById('pickupPoint').value} : {type:'delivery', city:document.getElementById('city').value.trim(), street:document.getElementById('street').value.trim(), house:document.getElementById('house').value.trim(), apt:(document.getElementById('apt').value.trim()||null) } }; }

  function submitOrder(){ var req=['lastName','firstName','phone']; var modeBtn=$deliveryGroup.querySelector('.active'); if(!modeBtn || modeBtn.getAttribute('data-val')!=='pickup'){ req.push('city','street','house'); } for(var i=0;i<req.length;i++){ var el=document.getElementById(req[i]); if(!el.value.trim()){ el.focus(); toast('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è'); return; } } var payload=buildPayload(); try{ var T=tg(); if(T&&T.sendData) T.sendData(JSON.stringify(payload)); console.log('CHECKOUT_PAYLOAD_TO_BOT',payload); toast('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –≤ –±–æ—Ç ‚úÖ'); cart.splice(0,cart.length); syncCart(); closeCart(); }catch(e){ console.error(e); toast('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏'); } }

  // --- Init ---
  render();
  syncCart();
})();
});
</script>
</body>
</html>
